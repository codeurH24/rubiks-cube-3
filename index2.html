<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSS CUBE</title>
    <link rel="stylesheet" href="static/css/cube.css">
    <link rel="stylesheet" href="static/css/debug.css">
</head>
<body>
    <!-- https://codepen.io/mirceageorgescu/pen/roblc -->
    <div class="wrapper">
        <div class="debug-bar">
            <div>axe cube <span id="debug-acube"></span></div>
            <div>cube19 <span id="debug-raxis"></span></div>
            <div>cube19-1 <span id="debug-c19-1"></span></div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
    <script>


        function cloneCube(id, x, y, z, css={}, classe={}) {
            let cube = `<div class="wrapper3D" id="cube${id}">
                <o class="x"></o>
                <b class="top">top
                </b> 
                <b class="bottom">bottom</b>
                <b class="left">left
                    <b class="back">back</b>
                </b> 
                <b class="right">right
                    <b class="front">front</b>
                </b>
            </div>`;
            $( "#cubeAxis" ).append( cube );
            
            let hotfixZ = (z < 0) ? 50 : 0 ;
            if (z == 0)
                hotfixZ = 0;
            else if (z < 0) 
                hotfixZ = 50;
            else if (z > 0)
                hotfixZ = -50;

            $('#cube'+id).css({
                transform: `translate3d(${100*parseInt(x)}%, ${100*parseInt(y)}%, ${(50*parseInt(z))}px)`,
            })
            
            return '#cube'+id;
        }

          $(function(){

            let v3 = { x:0,y:0,z:0 }

            let cube = {
                r: v3
            }



            let cubeAxis = `<div class="wrapper3D control" id="cubeAxis">
                <o class="x"></o>
                <b class="top">top
                </b> 
                <b class="bottom">bottom</b>
                <b class="left">left
                    <b class="back">back</b>
                </b> 
                <b class="right">right
                    <b class="front">front</b>
                </b>
            </div>`;
            $( ".wrapper" ).append( cubeAxis );

            let rAxis = `<div class="wrapper3D r-control" id="r-axis">
                <o class="x"></o>
                <b class="top">top
                </b> 
                <b class="bottom">bottom</b>
                <b class="left">left
                    <b class="back">back</b>
                </b> 
                <b class="right">right
                    <b class="front">front</b>
                </b>
            </div>`;
            $( "#cubeAxis" ).append( rAxis );

            

            let i = 0;
            for (let z = -1; z < 2; z++) {
                for (let y = -1; y < 2; y++) {
                    for (let x = -1; x < 2; x++) {
                        i++;
                        //console.log('cloneCube(', i, x, y, z,')')
                        let css = {}
                        let classe = ''

                        // css pour reperer les cubis
                        // avec ces class css
                        css = {background: 'red'};


                        let cubi = cloneCube(i, x, y, z);

                        if( z < 0) $(cubi).addClass('cubi-back');
                        if( z > 0) $(cubi).addClass('cubi-front');
                        if( y < 0) $(cubi).addClass('cubi-top');
                        if( y > 0) $(cubi).addClass('cubi-bottom');
                        if( x < 0) $(cubi).addClass('cubi-left');
                        if( x > 0) $(cubi).addClass('cubi-right');

                        //cubi.cube = {r: {x:0, y:0, z:0}}
                        //cubi.dataset['transform'] = JSON.stringify({r: {x:0, y:0, z:0}});
                        $(cubi).attr('data-transform-rotate', JSON.stringify({r: {x:0, y:0, z:0}}))
                        $(cubi).attr('data-transform-translate', JSON.stringify({t:{x:x*50, y:y*50, z:z*50}}))
                    }
                }
            }
            // dÃ©place le front sur l'axe de rotation
            $('#r-axis').append($('.cubi-front'))
              
            //$('.cubi-front *').css({background: '#7777'}); 
            let rx = 0;
            $( "body" ).keydown((e) => {
                
               // console.log(e.key)

                // test pour remetre le front dans l'axe du cube
                if(e.key === "Enter") {
                    $('#cubeAxis').append($('.cubi-front'))
                    $( ".cubi-front" ).each(function( index ) {
                        let transform = $(this).css('transform').match(/-?[0-9]+,/g);
                        let tx = transform[12];
                        let ty = transform[13];
                        let tz = transform[14];
                            console.log($(this).attr('id'), tx, ty, tz)
                            console.log($(this).css('position'), tx, ty, tz)
                            $(this).css('transform', 'translate3d('+tx+','+ty+','+tz+') rotateZ(-90deg)')
                        
                    });
                }

                var popup = document.querySelector('#cube19');
                var rect = popup.getBoundingClientRect();

                var cAxis = $( "#cubeAxis" ).offset();
                $('#debug-acube').text(parseInt(cAxis.left))
                var c19 = $( "#cube19" ).offset();
                var c19P = $( "#cube25" ).position();
                $('#debug-raxis').text(parseInt(c19P.left)+', '+parseInt(c19P.top))
                

                /*
                console.log("getBoundingClientRect(): \n" + "x: " + rect.left + "\ny: " + rect.top);
                console.log("offset: \n" + "x: " + popup.offsetLeft + "\ny: " + popup.offsetTop);
                console.log(rect);*/

                if (e.key === 'ArrowUp') cube.r.x += 1;
                if (e.key === 'ArrowDown') cube.r.x += -1;
                if (e.key === 'ArrowRight') cube.r.y += 1;
                if (e.key === 'ArrowLeft') cube.r.y += -1;

                $(".control").css({
                    transform: `rotateX(${cube.r.x}deg) rotateY(${cube.r.y}deg) rotateZ(${cube.r.z}deg) translate3d(0,0,0)`
                })
                
                
                if (e.key === '6') rx++;
                if (e.key === '4') rx--;
                
                $("#r-axis").css({
                    transform: ` rotateZ(${rx}deg)`
                })

                let cubiWork = [];
                $( ".cubi-front" ).each(function( index ) {
                    let t = JSON.parse($(this).attr('data-transform-rotate'));

                    cubiWork.push(this);

                    if (e.key === '6') t.r.z++;
                    if (e.key === '4') t.r.z--;

                    console.log(this.id, t)
                    $(this).attr('data-transform-rotate', JSON.stringify({r: {x:t.r.x, y:0, z:t.r.z}}))
                    
                });
                

                $( ".copy" ).each(function( index ) {
                    
                    for (let i = 0; i < cubiWork.length; i++) {
                        
                        if (this.id === cubiWork[i].id) continue;

                        var cubiTest1 = $( this).position();
                        var cubiTest2 = $( cubiWork[i] ).position();

                        let cmpX = parseInt(cubiTest1.left)-parseInt(cubiTest2.left);
                        let cmpY = parseInt(cubiTest1.top)- parseInt(cubiTest2.top);
                        if(cmpX < 10 && cmpX > -10 &&  cmpY < 10 && cmpY > -10)
                            console.log('correspondance ', this.id, cubiWork[i].id,  cmpX, cmpY);

                    }
                    
                    let t = JSON.parse($(this).attr('data-transform-rotate'));
                    //$(this).css("transform", 'rotateX('+tr.x+'deg)'+' rotateY('+tr.y+'deg)'+' rotateZ('+tr.z+'deg)');
                    //this.style.transform = 'rotateX('+t.r.x+'deg)  ';

                    this.style.transform = 'translate3d(-100%, -100%, 50px) rotateZ('+t.r.z+'deg)';

                    console.log(this.id, this.style.transform, t)
                });


                //console.log('transform axe cube', $('#cubeAxis').css('transform'))
                //$( ".cubi-front" ).clone().appendTo( "#cubeAxis" );
                $( ".cubi-front" ).each(function( index ) {
                    let transform = $(this).css('transform').match(/-?[0-9]+,/g);
                    let tx = transform[12];
                    let ty = transform[13];
                    let tz = transform[14];
                    if ($(this).attr('id') == 'cube19') {


                        if ($('#cube19-1').length === 0) {
                            console.log('create cube19-1')
                            let cubiClone = $( this ).clone();
                            cubiClone.attr('id', this.id+'-1');
                            cubiClone.addClass('copy');
                            cubiClone.appendTo( "#cubeAxis" );
                            cubiClone[0].cube = {r: {x:0, y:0, z:0}}
                        } else {
                            
                            $('#debug-c19-1').text(parseInt($("#"+this.id+'-1').position().left)+' ,'+parseInt($("#"+this.id+'-1').position().top))
                        }

                        //console.log($(this).attr('id'), tx, ty, tz)
                    }
                });

            });
          })
      </script>
    </body>
</html>